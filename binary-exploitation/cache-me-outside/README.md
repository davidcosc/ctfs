
# Cache Me Outside picoCTF 2021

## Solve locally and remote
- `chmod +x ./heapedit`
- `../../pwninit`
- `./cmo.py`
- `./cmo.py REMOTE`

## Explanation
As the hint suggests, this problem is focused on the tcache. The tcache is a glibc feature to speed up memory allocation in user space. It is used to cache previously freed memory chunks.
This means, that freed memory chunks are not cleaned up from the heap i.e. merged/coalesced with other free heap memory. Instead they are stored in so called bins inside the tcache for later reuse.
Subsequent malloc calls that request a size of memory, that matches a tcached chunk will allocate that chunk and remove it from the cache. Mallocs of this type do not have to go to the lengthy
process of requesting memory from the kernel via mmap.

Each thread has its own tcache. One of the reasons it was designed this way, is to prevent handling race conditions between threads.
In order to tackle the cache me outside problem, we have to understand two important tcache structures.

```
source: https://elixir.bootlin.com/glibc/latest/source/malloc/malloc.c#L3125

# define TCACHE_MAX_BINS 64
# define TCACHE_FILL_COUNT 7
/* When "x" is from chunksize().  */
# define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)

/* We overlay this structure on the user-data portion of a chunk when
   the chunk is stored in the per-thread cache.  */
typedef struct tcache_entry
{
  struct tcache_entry *next;
  /* This field exists to detect double frees.  */
  uintptr_t key;
} tcache_entry;

/* There is one of these for each thread, which contains the
   per-thread cache (hence "tcache_perthread_struct").  Keeping
   overall size low is mildly important.  Note that COUNTS and ENTRIES
   are redundant (we could have just counted the linked list each
   time), this is for performance reasons.  */
typedef struct tcache_perthread_struct
{
  uint16_t counts[TCACHE_MAX_BINS];
  tcache_entry *entries[TCACHE_MAX_BINS];
} tcache_perthread_struct;
```

By default, each thread has 64 singly-linked tcache bins. Each bin contains a maximum of 7 same-size chunks. The 64 bins are stored in the tcache_entry array entries of the tcache_perthread_struct.
The index for each bin is based on the respective chunk size. Once a chunk of memory is freed, the bin index is calculated using ` csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)`.

To understand, what the cache me outside tcache looks like, we first decompile the binary i.e. using an online decompiler like https://dogbolt.org/. After renaming some variables and translating string hex values
to their resective ascii characters, we get a main function that looks something like this.

```

```

